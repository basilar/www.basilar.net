<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wc</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            gap: 1px;
        }

        .panel {
            position: relative;
            flex: 1;
            min-width: 0;
            resize: horizontal;
            overflow: hidden;
            background: #111111;
        }

        .panel:last-child {
            resize: none;
            padding-right: 0;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
    </style>
    <script>
        function createVideoMonitor(videoElementId, fnToTargetURL, checkInterval = 5000) {
            let intervalId = null;
            let consecutiveErrors = 0;
            const MAX_ERRORS = 3;  // Maximum number of consecutive errors before forced reload

            // Get video element
            const videoElement = document.getElementById(videoElementId);
            if (!videoElement) {
                console.error('Video element not found:', videoElementId);
                return null;
            }

            // Status check function
            async function checkVideoStatus() {
                const status = {
                    readyState: videoElement.readyState,
                    paused: videoElement.paused,
                    ended: videoElement.ended,
                    error: videoElement.error,
                    networkState: videoElement.networkState,
                    currentTime: videoElement.currentTime
                };

                // Check if video is not playing properly
                const hasIssue = (
                    status.paused ||
                    status.ended ||
                    status.error ||
                    status.readyState < 3 ||  // HAVE_FUTURE_DATA = 3
                    // status.networkState === 2 || // NETWORK_LOADING
                    status.networkState === 3    // NETWORK_NO_SOURCE
                );

                if (hasIssue) {
                    consecutiveErrors++;
                    targetURL = await fnToTargetURL();
                    console.log('Video playback issue detected:', {
                        timestamp: new Date().toISOString(),
                        targetURL: targetURL,
                        status: status
                    });

                    // Try to recover playback
                    tryRecoverPlayback(status);
                } else {
                    consecutiveErrors = 0;  // Reset error counter if video is playing fine
                }
            }

            // Recovery function
            async function tryRecoverPlayback(status) {
                if (consecutiveErrors >= MAX_ERRORS) {
                    console.log('Multiple playback issues detected, reloading video source...');
                    targetURL = await fnToTargetURL();
                    console.log('targetURL -> ' + targetURL);
                    videoElement.src = targetURL;
                    consecutiveErrors = 0;
                }

                if (status.paused || status.ended) {
                    console.log('Attempting to restart playback...');
                    videoElement.play().catch(error => {
                        console.error('Error attempting to play:', error);
                    });
                }
            }

            // Start monitoring
            function startMonitoring() {
                if (intervalId) {
                    console.log('Monitoring already active');
                    return;
                }

                // Add event listeners
                videoElement.addEventListener('error', (e) => {
                    console.error('Video error event:', e.target.error);
                });

                videoElement.addEventListener('stalled', () => {
                    console.log('Video playback stalled');
                });

                // Start periodic checking
                intervalId = setInterval(checkVideoStatus, checkInterval);
                console.log('Video monitoring started');

                // Initial play attempt
                videoElement.play().catch(error => {
                    console.error('Initial playback failed:', error);
                });
            }

            // Stop monitoring
            function stopMonitoring() {
                if (intervalId) {
                    clearInterval(intervalId);
                    intervalId = null;
                    console.log('Video monitoring stopped');
                }
            }

            return {
                start: startMonitoring,
                stop: stopMonitoring
            };
        }
    
        // embedded   -> https://streamedian.com/saas/embed/?s=cnRzcDovL2FkbWluOkMzMDBocDZAMTk1LjIyOC4zLjkyL3N0cmVhbTE=&r=MTI4MHg3MjA=&w=d3NzOi8vc3RyZWFtZWRpYW4uY29tL2RlbW9uc3RyYXRpb24vd3Mv 
        // decoded    -> rtsp://admin:C300hp6@195.228.3.92/stream1
        // recoded    -> https://rtsp.me/embed/tF8FT4dN/
        function extractHashURLs(htmlContent) {
            const timeURLRegex = /https?:\/\/[^\s<>"']+\?[^\s<>"']*time=[^\s<>"']+/g; // regular expression to match URLs with time parameter
            const matches = htmlContent.match(timeURLRegex) || []; // all matches in the HTML content
            const uniqueURLs = [...new Set(matches)]; // remove duplicate URLs

            const hashURL = uniqueURLs[0];
            console.log("hashURL -> " + hashURL)
            return hashURL;
        }

        async function getHashValue(hashURL) {
            response = await fetch(hashURL);
            if (response.status === 200) {
                html = await response.text();
                console.log("html -> " + html)
                const subMatch = html.match(/sub\s*:\s*['"]([^'"]+)['"]/);

                const hashValue = subMatch[1];
                console.log("hashValue -> " + hashValue)
                return hashValue;
            }
        }

        async function extractVideoURL(uniqueId) {
            const embedURL = "https://rtsp.me/embed/" + uniqueId;
            const response = await fetch(embedURL);
            if (response.status === 200) {
                const html = await response.text();

                const hashURL = extractHashURLs(html)
                const hashValue = await getHashValue(hashURL)

                const timeStamp = new URL(hashURL).searchParams.get('time'); // get timestamp

                const videoURL = "https://lon.rtsp.me/" + hashValue + "/" + timeStamp + "/hls/" + uniqueId + ".m3u8" + "?ip=176.63.27.205";
                console.log("videoURL -> " + videoURL)

                return videoURL;
            }
        }

        
        document.addEventListener('DOMContentLoaded', async function () {
            const getSostoURL = async function() { 
                const sosto_uniqueId = "tF8FT4dN"
                return await extractVideoURL(sosto_uniqueId);
            }

            const getCsopakURL = async function () { return "https://s22.ipcamlive.com/streams/16eoymenxvuctdqhb/stream.m3u8" }
            const getAlsoorsURL = async function () { return "https://s12infocam.infornax.hu/t2/nv/alsoors-strand/playlist.m3u8" }               
            
            const webcams = [
                ['sosto-strand-video', getSostoURL, 3000],
                ['csopak-strand-video', getCsopakURL, 3000],
                ['alsoors-strand-video', getAlsoorsURL, 3000]
            ];

            webcams.forEach(([videoElementId, fnToTargetURL, refreshFrequency]) => {
                const videoMonitor = createVideoMonitor(videoElementId, fnToTargetURL, refreshFrequency);
                videoMonitor.start();
            });
        });
    </script>
</head>

<body>
    <div class="container">
        <div class="panel">
            <video id="alsoors-strand-video" muted controls></video>
        </div>

        <div class="panel">
            <video id="csopak-strand-video" muted controls></video>
        </div>

        <div class="panel">
            <video id="sosto-strand-video" muted controls></video>
        </div>

</html>
